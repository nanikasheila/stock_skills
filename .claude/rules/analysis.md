# 銘柄分析ルール

銘柄分析・投資判断を行う際に**必ず遵守する**チェックリスト。
過去のインシデント（事実誤認・指標見落とし）から導出した再発防止策。

## 原則

1. **データファースト** — 推測・仮定で分析を進めない。yfinance 等で取得した数値を根拠にする
2. **前提の明示と検証** — 「〇〇がまだ発売されていない」「〇〇が成長している」等の前提は、データで裏取りしてから述べる
3. **矛盾検出** — 複数指標の方向性が矛盾する場合、必ずフラグを立てて深掘りする

---

## 必須チェックリスト

### Phase 1: 事実確認（分析開始前）

銘柄に言及する前に、以下を確認する:

- [ ] **現在の日付を認識しているか**（今日は何年何月か）  
- [ ] **企業の主要製品・サービスの現状**を確認したか（発売済み/未発売/終了等）  
- [ ] **直近の決算発表日**はいつか（yfinance `earnings_dates` または直近Q業績の日付から推定）  
- [ ] **ユーザーの前提や文脈**と自分の認識にズレがないか確認したか

> **インシデント事例**: Switch2が2025年に発売済みなのに、未発売として分析し「発売がカタリスト」と誤った結論を出した。

### Phase 2: バリュエーション整合性

以下の指標を**必ずセットで確認**し、方向性の矛盾がないかチェックする:

| チェック項目 | 方法 | 警告条件 |
|:---|:---|:---|
| **EPS方向性** | FwdEPS vs TrailEPS | FwdEPS < TrailEPS → 🔴 減益予想 |
| **PEG整合性** | PEGの分母が過去成長か将来成長か | earningsGrowth（過去）で割ったPEGは将来を反映しない |
| **Revenue vs Earnings 乖離** | revenueGrowth vs earningsGrowth | 売上増なのにEPS減 → コスト構造の問題 |
| **粗利率の変化** | grossMargins の推移 | 粗利率が5pt以上低下 → 構造的コスト増 |
| **FwdPER vs 業界平均** | 同業他社との比較 | FwdPER が業界中央値の2倍以上 → 割高警告 |

> **インシデント事例**: 富士通でPEG 0.40（earningsGrowth +60%ベース）を「割安」と判断したが、FwdEPS は −6.7%減益予想だった。過去の好業績の数字で将来の割安感を誤認。

### Phase 3: 成長ストーリーの検証

- [ ] **「成長株」と判断する場合、FwdEPS > TrailEPS であることを確認**
- [ ] **earningsGrowth（過去実績）と FwdEPS成長率（将来予想）が同方向か確認**
- [ ] **四半期EPS が直近で鈍化・減少していないか確認**（QoQ でチェック）
- [ ] **売上成長率の比較対象期が「谷」でないか確認**（前年同期が異常に低いと見かけの高成長に）

> **インシデント事例**: ANETの四半期EPSがQ2 $0.71→Q3 $0.68に減少していたが、「一括OK」と判断。EPS鈍化の兆候を見落とした。

---

## 分析レポートの必須出力項目

銘柄分析を口頭で行う場合でも、以下を必ず含める:

### 必須セクション

1. **EPS方向性**: FwdEPS vs TrailEPS の比較と成長率  
2. **バリュエーション水準**: FwdPER（TrailPERではなく）で評価  
3. **整合性フラグ**: 上記チェックで矛盾がある場合は ⚠️ で明示  

### 警告表示ルール

| 条件 | 表示 |
|:---|:---|
| FwdEPS < TrailEPS | 🔴 **減益予想**: FwdEPS ○○ < TrailEPS ○○ (−X.X%) |
| PEG < 1.0 だが FwdEPS減少 | ⚠️ **PEG矛盾**: PEGは過去成長ベース。将来は減益予想 |
| 粗利率が前期比5pt以上低下 | ⚠️ **粗利率悪化**: XX% → YY% (−Zpt) |
| 四半期EPSがQoQで減少 | ⚠️ **EPS鈍化**: Q直近 $X.XX → $Y.YY (−Z.Z%) |

---

## 禁止事項

1. **未検証の時系列前提で分析しない** — 「〇〇は未発売」「〇〇は今後発表される」等は、株価推移・業績データで裏取りする
2. **過去の成長率だけで「割安」と断言しない** — PEGのearningsGrowthは過去データ。FwdEPS方向と合わせて判断する
3. **TrailPERだけで割高/割安を判断しない** — 成長株はFwdPERで評価する。TrailPERは参考値

---

## generate_report.py での自動チェック

`generate_report.py` は以下の整合性チェックを自動実行し、警告があればレポートに表示する:

- `check_eps_direction()`: FwdEPS vs TrailEPS の方向性
- `check_growth_consistency()`: earningsGrowth vs FwdEPS成長率の整合性
- `check_margin_deterioration()`: 粗利率の年次変化
- `check_quarterly_eps_trend()`: 四半期EPSのQoQトレンド

これらは `src/core/indicators.py` の `run_consistency_checks()` で一括実行される。
