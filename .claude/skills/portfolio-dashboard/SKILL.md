# Portfolio Dashboard

ポートフォリオの資産推移・リスク指標・構造分析をブラウザ上でインタラクティブに可視化するダッシュボード。

## 概要

### KPI カード（ページ上部）

- **総資産額**: 現在の円換算総資産 + 前日比変動（額・率）
- **評価損益**: 投資元本との差分（額・率）
- **保有銘柄数 / 為替レート**: 銘柄数 + 主要FXレート表示

### サブ KPI

- **日次変動**: 前日比の変動額・変動率
- **リスク指標**: シャープレシオ / ボラティリティ / 最大ドローダウン / カルマーレシオ
- **ベンチマーク超過リターン**: 選択ベンチマーク対比の超過リターン（YTD / 1Y / 3Y）
- **トップ / ワーストパフォーマー**: 期間内の最高・最低リターン銘柄

### チャート

- **総資産推移**: 積み上げ面 / 折れ線 / 積み上げ棒（3スタイル切替）
- **ドローダウン推移**: 高値からの下落率を時系列で表示
- **ローリングシャープレシオ**: 60日ローリングウィンドウでシャープレシオの推移を表示
- **投資元本 vs 評価額**: 累積投資額と評価額の推移を重ね合わせ
- **将来予測（プロジェクション）**: 過去リターンベースの3シナリオ将来推計
- **セクター構成**: ドーナツチャートでセクター別比率
- **通貨構成**: ドーナツチャートで通貨別比率
- **ツリーマップ**: 銘柄の評価額をツリーマップで可視化（セクター色分け）
- **ウェイトドリフト警告**: 初期配分と現在配分の乖離を棒グラフで表示（閾値超で⚠️）
- **相関ヒートマップ**: 銘柄間の日次リターン相関を色付きマトリクスで表示
- **銘柄別個別チャート**: 各銘柄の評価額推移ミニチャート（オプション）
- **月次サマリー**: 月末資産額推移 + 前月比変動率チャート
- **売買アクティビティ**: 取引フロー（買い / 売り）の時系列チャート

## 起動方法

```bash
python3 .claude/skills/portfolio-dashboard/scripts/run_dashboard.py
```

### オプション

| パラメータ | デフォルト | 説明 |
|:---|:---|:---|
| `--port` | 8501 | サーバーポート番号 |
| `--no-browser` | false | ブラウザを自動で開かない |

起動後、`http://localhost:8501` でダッシュボードにアクセス可能。

## サイドバー操作

サイドバーは **目次タブ** と **設定タブ** の2タブ構成。

### 目次タブ（📋）

各セクションへのアンカーリンク一覧。

### 設定タブ（⚙️）

| 項目 | 選択肢 | 説明 |
|:---|:---|:---|
| 表示期間 | 1mo / 3mo / 6mo / 1y / 2y / 3y / 5y / max | 株価取得期間 |
| チャートスタイル | 積み上げ面 / 折れ線 / 積み上げ棒 | 総資産チャートの描画方式 |
| ベンチマーク | VTI / SPY / QQQ / ^N225 / 1306.T | 超過リターン比較対象 |
| 銘柄別個別チャート | ON / OFF | 各銘柄のミニチャート表示切替 |
| 将来予測 | ON / OFF | プロジェクションチャート表示切替 |
| 予測年数 | 1 〜 30 年（デフォルト 5） | 将来推計の期間 |
| 月額追加投資 | 0 〜（デフォルト 0） | 積立シミュレーション用 |
| 自動更新 | OFF / 60s / 120s / 300s | ページ自動リロード間隔 |

## 機能詳細

### 日次変動 & ベンチマーク超過リターン

- `compute_daily_change()`: 直近の日次リターンを算出
- `compute_benchmark_excess()`: 選択ベンチマークの同期間リターンとの差分（YTD / 1Y / 3Y）

### トップ / ワーストパフォーマー

- `compute_top_worst_performers()`: 表示期間内の全銘柄リターンを計算し、最高 / 最低を抽出

### ドローダウン & ローリングシャープレシオ

- `compute_drawdown_series()`: 累積最大値からの下落率系列
- `compute_rolling_sharpe()`: 60日ローリングウィンドウのシャープレシオ系列

### ツリーマップ

- `build_treemap_chart()`: 評価額ベースのツリーマップ（Plotly Treemap、セクター別色分け）

### ウェイトドリフト警告

- `compute_weight_drift()`: 初期配分と現在配分の乖離を計算
- 乖離が閾値（デフォルト 5%pt）を超える銘柄に ⚠️ 警告マーカーを付与

### 相関ヒートマップ

- `compute_correlation_matrix()`: 銘柄間の日次リターン相関行列を計算
- `build_correlation_chart()`: Plotly ヒートマップで可視化（カラースケール: RdBu）

### CSV エクスポート

- 保有銘柄テーブルを CSV としてダウンロード可能（Streamlit `st.download_button`）

## データソース

| データ | ソース | 更新頻度 |
|:---|:---|:---|
| 保有銘柄 | portfolio.csv | 売買記録時 |
| 売買履歴 | data/history/trade/*.json | 売買記録時 |
| 株価 | yfinance（24hキャッシュ） | ページロード時に自動取得 |
| 為替レート | yfinance FXペア | ページロード時に自動取得 |
| ベンチマーク | yfinance（VTI/SPY/QQQ/^N225/1306.T） | ページロード時に自動取得 |

## 依存

- streamlit >= 1.30.0
- streamlit-autorefresh >= 1.0.1
- plotly >= 5.18.0
- numpy
- 既存モジュール: `src/core/portfolio/`, `src/data/yahoo_client.py`, `src/data/history_store.py`

## ファイル構成

```
.claude/skills/portfolio-dashboard/
├── SKILL.md                     # 本ファイル
└── scripts/
    ├── run_dashboard.py         # 起動スクリプト
    ├── app.py                   # Streamlit メインアプリ（892行）
    └── components/
        ├── data_loader.py       # データ取得・計算ロジック
        └── charts.py            # Plotly チャート構築
```

## 技術詳細

### 資産推移の計算方法

1. `data/history/trade/` の売買履歴を時系列で読み込み
2. 各取引日時点での累積保有株数を復元
3. yfinance から各銘柄の日次終値を取得
4. 各日の「保有株数 × 終値 × 為替レート」で円換算評価額を算出
5. Plotly でインタラクティブに可視化

### キャッシュ戦略

- `@st.cache_data(ttl=300)` で5分TTLキャッシュ
- 自動更新時は既存キャッシュを再利用（TTL内）

### CSS テーマ

- CSS 変数によるテーマ統一（`--primary-gradient`, `--kpi-bg` 等）
- KPI カードは 3 階層デザイン（メイン KPI → サブ KPI → 詳細指標）
